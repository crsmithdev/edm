<audio-context>
  <purpose>EDM audio analysis: BPM, beats, structure, bars</purpose>

  <!-- EDM terminology: see edm-terminology.xml -->

  <bpm cascade="metadata → beat_this → librosa">
    <detector name="beat_this" file="src/edm/analysis/bpm_detector.py:224" desc="Neural beat tracker (ISMIR 2024), handles tempo multiplicity"/>
    <detector name="librosa" desc="Spectral flux + autocorrelation fallback"/>
  </bpm>

  <structure cascade="msaf → energy">
    <detector name="msaf" file="src/edm/analysis/structure_detector.py:55" desc="Spectral flux boundaries + energy-based EDM labeling"/>
    <detector name="energy" file="src/edm/analysis/structure_detector.py:260" desc="RMS + spectral contrast, gradient peaks, min 8s sections"/>
    <labels>intro|buildup|main|breakdown|outro</labels>
    <note>drops are momentary events, not sections; high-energy sections labeled "main"</note>
  </structure>

  <bars file="src/edm/analysis/bars.py" fns="time_to_bars,bars_to_time,bar_count_for_range" time_sig="4/4" index="1-based" graceful="bar fields None when BPM unavailable">
    <example>Bar 17 at 128 BPM, downbeat=0.5s: time = 0.5 + (17-1) × 60/128 × 4 = 8.0s</example>
  </bars>

  <models>
    <BPMResult bpm="float" confidence="0-1" source="metadata|computed"
               method="beat-this|librosa|id3" alternatives="list[float]"/>
    <Section label="str" start_time="float" end_time="float" confidence="0-1"
             start_bar="float|None" end_bar="float|None" bar_count="float|None"/>
    <StructureResult sections="list[Section]" events="list[Event]" duration="float"
                     detector="msaf|energy" bpm="float|None" downbeat="float" time_sig="tuple"/>
  </models>

  <files>
    <f path="src/edm/analysis/bpm.py" api="analyze_bpm()"/>
    <f path="src/edm/analysis/structure.py" api="analyze_structure()"/>
    <f path="src/edm/analysis/bpm_detector.py" role="implementations"/>
    <f path="src/edm/analysis/structure_detector.py" role="implementations"/>
    <f path="src/edm/analysis/bars.py" role="bar calculations"/>
  </files>

  <patterns>
    <two-tier desc="Public API (bpm.py, structure.py) → Detectors (*_detector.py)"/>
    <caching file="src/edm/io/audio.py" size="10 tracks"/>
    <fallbacks desc="Graceful degradation, partial results, log warnings"/>
  </patterns>

  <constraints perf="30s/track, 4GB RAM" accuracy="BPM ±0.5, drop precision >90%"/>
</audio-context>
