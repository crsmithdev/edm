<audio-context>
  <purpose>EDM audio analysis: BPM, beats, structure, bars</purpose>

  <edm-terms>
    <intro energy="low" desc="Opening, sparse drums, atmospheric, 8-32 bars"/>
    <buildup energy="ascending" desc="Tension, layering, risers, filters, 8-16 bars"/>
    <drop energy="peak" desc="Main hook, full instrumentation, heavy bass, 16-32 bars" note="EDM equivalent of chorus"/>
    <breakdown energy="moderate" desc="Contrast, reduced elements, removed bass/drums, 8-16 bars" note="EDM equivalent of verse"/>
    <outro energy="descending" desc="Closing, gradual removal, DJ transition, 16-32 bars"/>
    <bar desc="Measure, 4 beats in 4/4 time, 1-based indexing"/>
    <downbeat desc="First beat of measure (beat 1), strongest anchor"/>
    <phrase desc="Complete musical idea, typically 8-16 bars"/>
  </edm-terms>

  <bpm>
    <cascade>1. metadata (ID3/FLAC/MP4) → 2. beat_this → 3. librosa</cascade>
    <detector name="beat_this" file="src/edm/analysis/bpm_detector.py:224">
      Neural beat tracker (ISMIR 2024), handles tempo multiplicity
    </detector>
    <detector name="librosa">Spectral flux + autocorrelation fallback</detector>
  </bpm>

  <structure>
    <cascade>auto: MSAF → energy fallback</cascade>
    <detector name="msaf" file="src/edm/analysis/structure_detector.py:55">
      Spectral flux boundaries + energy-based EDM labeling
    </detector>
    <detector name="energy" file="src/edm/analysis/structure_detector.py:260">
      RMS + spectral contrast, gradient peaks, min 8s sections
    </detector>
    <labels>intro|buildup|main|breakdown|outro</labels>
    <note>drops are momentary events, not sections; high-energy sections labeled "main"</note>
  </structure>

  <bars file="src/edm/analysis/bars.py">
    <fn>time_to_bars(), bars_to_time(), bar_count_for_range()</fn>
    <default time_sig="4/4" index="1-based"/>
    <graceful>bar fields None when BPM unavailable</graceful>
  </bars>

  <models>
    <BPMResult bpm="float" confidence="0-1" source="metadata|computed"
               method="beat-this|librosa|id3" alternatives="list[float]"/>
    <Section label="str" start_time="float" end_time="float" confidence="0-1"
             start_bar="float|None" end_bar="float|None" bar_count="float|None"/>
    <StructureResult sections="list[Section]" events="list[Event]" duration="float"
                     detector="msaf|energy" bpm="float|None" downbeat="float" time_sig="tuple"/>
  </models>

  <files>
    <f path="src/edm/analysis/bpm.py" api="analyze_bpm()"/>
    <f path="src/edm/analysis/structure.py" api="analyze_structure()"/>
    <f path="src/edm/analysis/bpm_detector.py" role="implementations"/>
    <f path="src/edm/analysis/structure_detector.py" role="implementations"/>
    <f path="src/edm/analysis/bars.py" role="bar calculations"/>
  </files>

  <patterns>
    <two-tier>Public API (bpm.py, structure.py) → Detectors (*_detector.py)</two-tier>
    <caching file="src/edm/io/audio.py" size="10 tracks"/>
    <fallbacks>Graceful degradation, partial results, log warnings</fallbacks>
  </patterns>

  <constraints perf="30s/track, 4GB RAM" accuracy="BPM ±0.5, drop precision >90%"/>
</audio-context>
